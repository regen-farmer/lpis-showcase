<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Leaflet - RegenMaps</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- MapLibre GL JS (for vector tiles) -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@^5.0.0/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl@^5.0.0/dist/maplibre-gl.js"></script>
    <!-- Leaflet MapLibre GL plugin -->
    <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.0.22/leaflet-maplibre-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #201c2b;
      }
      html,
      body,
      #map {
        height: 100vh;
        width: 100%;
      }
      .nav-container {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        font-family: Arial, Helvetica, sans-serif;
      }
      .brand-inner {
        display: flex;
        align-items: center;
        border: 1px solid #888;
        background-color: white;
        padding: 10px;
        gap: 10px;
        border-radius: 20px;
        margin-bottom: 10px;
        text-decoration: none;
        color: black;
      }
      .brand-inner:hover {
        background: #f0f0f0;
      }
      .back-link {
        display: flex;
        align-items: center;
        background: white;
        padding: 10px;
        border-radius: 20px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
        border: 1px solid #888;
        gap: 8px;
      }
      .back-link:hover {
        background: #f0f0f0;
      }
      .leaflet-popup-content {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="nav-container">
      <a href="https://regenfarmer.com" class="brand-inner">
        <img src="./icon.png" alt="Logo" width="20" height="20"> Powered by Regen Farmer
      </a>
      <a href="./" class="back-link">
        ‚Üê Back to Examples
      </a>
    </div>

    <div id="map"></div>

    <script type="module">
      const tilesets = [
        "AT_INSPIRE_FELDSTUECKE_2019_POLYGON",
        "DK_Marker_2023",
        "FI_AgriculturalParcel_2023",
        "FR_PARCELLES_GRAPHIQUES_2022",
        "NL_brpgewaspercelen_definitief_2022",
        "CZ_2024_DPB",
        "DE_Brandenburg_2025",
        "DE_Niedersachen_2024",
        "IE_Parcels_2023",
        "PT_Solo_2022",
        "BE_Vlaanderen_2022"
      ];

      // Fetch the CARTO style and modify it to add our LPIS layers
      const baseStyle = await fetch('https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json')
        .then(response => response.json());

      // Add LPIS sources and layers to the style
      for (const tileset of tilesets) {
        baseStyle.sources[`${tileset}_source`] = {
          type: "vector",
          url: `https://maps.regenfarmer.com/api/tilesets/${tileset}`
        };

        // Find a good insertion point (before labels)
        const labelIndex = baseStyle.layers.findIndex(l => l.id === 'waterway_label');
        const insertIndex = labelIndex !== -1 ? labelIndex : baseStyle.layers.length;

        baseStyle.layers.splice(insertIndex, 0, {
          id: `${tileset}_fieldfill`,
          type: "fill",
          source: `${tileset}_source`,
          "source-layer": "fields",
          paint: {
            "fill-color": "rgba(127,34,192,0.6)"
          }
        });

        baseStyle.layers.splice(insertIndex + 1, 0, {
          id: `${tileset}_fieldline`,
          type: "line",
          source: `${tileset}_source`,
          "source-layer": "fields",
          paint: {
            "line-color": "black",
            "line-width": 1
          }
        });
      }

      // Create Leaflet map
      const map = L.map('map', {
        center: [48.43, 7.82],
        zoom: 4,
        zoomControl: false
      });

      // Add zoom control to top-right
      L.control.zoom({ position: 'topright' }).addTo(map);

      // Add MapLibre GL layer with our combined style
      const gl = L.maplibreGL({
        style: baseStyle,
        interactive: true
      }).addTo(map);

      // Set up popup for feature info
      const popup = L.popup({ closeButton: false, autoPan: false });

      // Access the MapLibre map instance for feature querying
      gl.getMaplibreMap().on('load', () => {
        const mlMap = gl.getMaplibreMap();

        // Get all field layer IDs
        const fieldLayers = tilesets.map(t => `${t}_fieldfill`);

        mlMap.on('mousemove', (e) => {
          const features = mlMap.queryRenderedFeatures(e.point, {
            layers: fieldLayers
          });

          if (features.length > 0) {
            mlMap.getCanvas().style.cursor = 'help';

            let html = '';
            for (const [key, value] of Object.entries(features[0].properties)) {
              html += `<strong>${key}:</strong> ${value}<br/>`;
            }

            popup
              .setLatLng([e.lngLat.lat, e.lngLat.lng])
              .setContent(html)
              .openOn(map);
          } else {
            mlMap.getCanvas().style.cursor = '';
            map.closePopup();
          }
        });

        mlMap.on('mouseout', () => {
          map.closePopup();
        });
      });
    </script>
  </body>
</html>
